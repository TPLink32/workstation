<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>OpenResty - Using LuaRocks</title>
	<link href="fonts.css" tppabs="https://openresty.org/css/fonts.css" rel='stylesheet' type='text/css'>
	<!--
	If you ever wanted to use LESS instead of CSS...
	<link rel="stylesheet" type="text/less" href="/css/main.less">
	<script src="/js/less.js"></script>
	-->
	<link rel="stylesheet" type="text/css" href="main.css" tppabs="http://openresty.org/css/main.css">
</head>
<body>

<header role="header">
        <p class="site-name left">
                <a href="javascript:if(confirm(%27http://openresty.org/cn/.  \n\nThis file was not retrieved by Teleport Ultra, because the server reports that this file cannot be found.  \n\nDo you want to open it from the server?%27))window.location=%27http://openresty.org/cn/.%27" tppabs="http://openresty.org/cn/.">OpenResty</a>
                <small>通过扩展 NGINX 和 Lua 实现的可伸缩的 Web 平台</small>
        </p><!-- / site-name -->

        <form action="http://openresty.org/cn/search.html" class="right">
                <fieldset>
                        <input type="search" name="query" id="search"
                               placeholder="搜索 OpenResty.org 中文站" required>
                </fieldset>
        </form>
</header>


	<div id="wrapper">
		<div class="sidebar sleft">
			<nav id="nav">
<ul>
<li><a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">概览</a></li>
<li><a href="components.html" tppabs="http://openresty.org/cn/components.html">组件</a></li>
<li><a href="getting-started.html" tppabs="http://openresty.org/cn/getting-started.html">新手上路</a></li>
<li><a href="samples.html" tppabs="http://openresty.org/cn/samples.html">样例</a></li>
<li><a href="benchmark.html" tppabs="http://openresty.org/cn/benchmark.html">性能评测</a></li>
<li><a href="presentations.html" tppabs="http://openresty.org/cn/presentations.html">幻灯片</a></li>
<li><a href="ebooks.html" tppabs="http://openresty.org/cn/ebooks.html">电子图书</a></li>
<li><a href="resources.html" tppabs="http://openresty.org/cn/resources.html">资源</a></li>
<li><a href="download.html" tppabs="http://openresty.org/cn/download.html">下载</a></li>
<li><a href="installation.html" tppabs="http://openresty.org/cn/installation.html">安装</a></li>
<li><a href="changes.html" tppabs="http://openresty.org/cn/changes.html">变更历史</a></li>
<li><a href="quality-assurance.html" tppabs="http://openresty.org/cn/quality-assurance.html">测试</a></li>
<li><a href="contact-us.html" tppabs="http://openresty.org/cn/contact-us.html">联系我们</a></li>
<li><a href="javascript:if(confirm(%27https://openresty.org/survey/cn  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27https://openresty.org/survey/cn%27" tppabs="https://openresty.org/survey/cn">用户问卷调查</a></li>
<li><a href="donate-online.html" tppabs="http://openresty.org/cn/donate-online.html">捐助</a></li>
<li><a href="donors.html" tppabs="http://openresty.org/cn/donors.html">捐款者</a></li>
<li><a href="about.html" tppabs="http://openresty.org/cn/about.html">关于</a></li>
<li><a href="javascript:if(confirm(%27http://openresty.org/en/  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://openresty.org/en/%27" tppabs="http://openresty.org/en/">English Site</a></li>
</ul>

			</nav><!-- / nav -->

<ul class="buttons">
    <!-- <li><a href="#" class="btn rss">RSS Feed</a></li> -->
    <li>
        <!-- <a href="#" class="btn paypal">Donate with PayPal</a> -->
        <form name="_xclick" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">
        <input type="hidden" name="cmd" value="_xclick">
        <input type="hidden" name="business" value="agentzh@gmail.com">
        <input type="hidden" name="item_name" value="OpenResty Donation (in USD)">
        <input type="hidden" name="currency_code" value="USD">
        <input type="hidden" name="amount" value="">
        <input type="image" src="donate_paypal.gif" tppabs="http://openresty.org/images/donate_paypal.gif" border="0" name="submit" alt="Donate with PayPal">
        </form>
    </li>
</ul>


		</div><!-- / sidebar left -->
		
		<section id="main">
<div class="item">
        <header>
                <h2>Using LuaRocks</h2>
                <small>
                    <a href="yichun-zhang.html" tppabs="http://openresty.org/cn/yichun-zhang.html">
                    Yichun Zhang
                    </a>,
                    08 Nov 2011 (created 07 Aug 2011)</small>
                <div class="options">
                        <!--
                        <a href="#" class="trigger">Show Options</a>
                        <ul class="first-level">
                                <li><a href="#">close</a></li>
                                <li><a href="#">close others</a></li>
                                <li><a href="#">view</a></li>
                                <li><a href="#">fields</a></li>
                                <li><a href="#">syncing</a></li>
                                <li><a href="#">permalink</a></li>
                                <li><a href="#">references</a></li>
                                <li>
                                        <a href="#">jump</a>
                                        <ul class="second-level">
                                                <li><a href="#">Benchmark</a></li>
                                                <li><a href="#">Presentations</a></li>
                                                <li><a href="#">eBooks</a></li>
                                        </ul>
                                </li>
                        </ul>
                        -->
                </div><!-- / options -->
        </header>
        <div class="body">
<p>使用 LuaRocks</p>
<p>这个示例中展示了在 <a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a> 中使用 <a href="javascript:if(confirm(%27http://www.luarocks.org/  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.luarocks.org/%27" tppabs="http://www.luarocks.org/">LuaRocks</a> 。这个示例已经在 Linux 和 Mac OS X 下，通过 Lua 解释器与 <a href="luajit.html" tppabs="http://openresty.org/cn/luajit.html">LuaJIT</a> 的测试。</p>
<p>LuaRocks 是一个部署和管理 Lua 模块的系统。</p>
<p>LuaRocks 允许通过 &quot;rocks&quot; 安装独立的 Lua 模块,并且包含附加的版本信息。我们假设您已经在默认的路径里面安装了<a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a>.即, <code>/usr/local/openresty</code>. 您可以根据实际安装<a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a>的路径来调整本示例中的路径。如果您还没有安装 OpenResty, 请查看<a href="download.html" tppabs="http://openresty.org/cn/download.html">下载</a> 与<a href="installation.html" tppabs="http://openresty.org/cn/installation.html">安装</a>页.</p>
<h1 id="-luarocks">安装 LuaRocks</h1>
<p>首先让我们来安装 LuaRocks:</p>
<p>请您从 <a href="javascript:if(confirm(%27http://www.luarocks.org/en/Download  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27http://www.luarocks.org/en/Download%27" tppabs="http://www.luarocks.org/en/Download" class="uri">http://www.luarocks.org/en/Download</a> 下载最新版本的 LuaRocks . 当写这篇文章的时候,最新版本为 <code>2.0.4.1</code>（译注：目前最新版本已经更新到了2.0.5）, 在这个示例中我们将使用这个版本。（译注:如果您在安装了2.0.6版本的 LuaRocks，请记得填写正确的Lua解释器的地址,无论您使用 Lua 官方的解释器还是选择 <a href="luajit.html" tppabs="http://openresty.org/cn/luajit.html">LuaJIT</a>，请确保安装时 LuaRocks 能找到它,否则 LuaRocks 可能报错）</p>
<pre><code>wget http://luarocks.org/releases/luarocks-2.0.4.1.tar.gz
tar -xzvf luarocks-2.0.4.1.tar.gz
cd luarocks-2.0.4.1/
./configure
make
sudo make install</code></pre>
<h1 id="-luarocks-lua-md5-">通过 LuaRocks安装 Lua MD5 库</h1>
<p>在本示例中, 我们将使用 Lua MD5 library 作为服务器上的一个例子, 所以我们需要通过 LuaRocks 来安装它:</p>
<pre><code>sudo luarocks install md5</code></pre>
<h1 id="-openresty-">配置我们的 OpenResty 应用</h1>
<p>Let's change the current directory to <code>/usr/local/openresty/nginx/</code>:</p>
<pre><code>cd /usr/local/openresty/nginx/</code></pre>
<p>然后, 使用您喜欢的编辑器（例如 vim 或 emacs ）根据下面的内容，编辑 <code>conf/nginx.conf</code> 文件:</p>
<pre><code>worker_processes  1;   # we could enlarge this setting on a multi-core machine
error_log  logs/error.log warn;

events {
    worker_connections  1024;
}

http {
    lua_package_path &#39;conf/?.lua;;&#39;;

    server {
        listen       80;
        server_name  localhost;

        location = /luarocks {
            content_by_lua &#39;
                local foo = require(&quot;foo&quot;)
                foo.say(&quot;hello, luarocks!&quot;)
            &#39;;
        }
    }
}</code></pre>
<p>最后,我们创建下面两个 Lua 模块文件 <code>conf/foo.lua</code></p>
<pre><code>-- conf/foo.lua

module(&quot;foo&quot;, package.seeall)

local bar = require &quot;bar&quot;

ngx.say(&quot;bar loaded&quot;)

function say (var)
    bar.say(var)
end</code></pre>
<p>和 <code>conf/bar.lua</code> 文件</p>
<pre><code>-- conf/bar.lua

module(&quot;bar&quot;, package.seeall)

local rocks = require &quot;luarocks.loader&quot;
local md5 = require &quot;md5&quot;

ngx.say(&quot;rocks and md5 loaded&quot;)

function say (a)
    ngx.say(md5.sumhexa(a))
end</code></pre>
<h1 id="-nginx-">开启 <a href="nginx.html" tppabs="http://openresty.org/cn/nginx.html">Nginx</a> 服务</h1>
<p>现在我们通过 <a href="nginx.html" tppabs="http://openresty.org/cn/nginx.html">Nginx</a> 开启我们的应用:</p>
<pre><code>ulimit -n1024   # increase the maximal fd count limit per process
./sbin/nginx</code></pre>
<p>如果您已经开启了 <a href="nginx.html" tppabs="http://openresty.org/cn/nginx.html">Nginx</a> 服务,请先关闭后在重新开启:</p>
<pre><code>./sbin/nginx -s stop  #（译注:我们也可以使用平滑重启命令完成此操作 ./sbin/nginx -s reload）</code></pre>
<h1>测试我们的应用</h1>
<p>现在我们通过<code>curl</code> 工具或者任意兼容HTTP协议的浏览器测试我们的应用:</p>
<pre><code>curl http://localhost/luarocks</code></pre>
<p>我们在第一次运行的时候得到以下的内容:</p>
<pre><code>rocks and md5 loaded
bar loaded
85e73df5c41378f830c031b81e4453d2</code></pre>
<p>第二次运行的时候得到以下内容:</p>
<pre><code>85e73df5c41378f830c031b81e4453d2</code></pre>
<p>之所以会出现这样的输出数据是因为 <a href="lua-nginx-module.html" tppabs="http://openresty.org/cn/lua-nginx-module.html">Lua Nginx Module</a> 默认缓存了已经加载过的Lua模块 并且这些输出数据的代码是在 Lua 加载时运行的因此他们将不会在执行.</p>
<p>现在，让我们来做一些基准测试吧:</p>
<pre><code>ab -c10 -n50000 http://127.0.0.1/luarocks</code></pre>
<p>测试在是我的 Thinkpad T400 笔记本上进行的(Core2Duo T9600 CPU), 下面是测试中产生的数据</p>
<pre><code>Server Software:        ngx_openresty/1.0.4.2rc10
Server Hostname:        localhost
Server Port:            80

Document Path:          /luarocks
Document Length:        33 bytes

Concurrency Level:      10
Time taken for tests:   3.052 seconds
Complete requests:      50000
Failed requests:        0
Write errors:           0
Total transferred:      9400188 bytes
HTML transferred:       1650033 bytes
Requests per second:    16380.48 [#/sec] (mean)
Time per request:       0.610 [ms] (mean)
Time per request:       0.061 [ms] (mean, across all concurrent requests)
Transfer rate:          3007.41 [Kbytes/sec] received</code></pre>
<p>注意哦上面测试的吞吐量是由单个 nginx 进程达到的。当您自己做这样的基准测试时，请注意在 <code>nginx.conf</code> 中设定的错误日志级别以及不要超过您本地机器运行的动态端口范围，否则的话测试的数据会显著变慢。</p>
<h1>已知问题</h1>
<p><a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a> 1.0.4.2rc10之前的版本, 将导致<code>lua_code_cache</code> 运行时在LuaRocks 中的<a href="lua-nginx-module.html" tppabs="http://openresty.org/cn/lua-nginx-module.html">Lua Nginx Module</a> 模块抛出以下异常<code>error.log</code>:</p>
<pre><code>lua handler aborted: runtime error: stack overflow</code></pre>
<p>如果您正在使用的 <a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a> 版本是 1.0.4.2rc10 之前的版本, 请您考虑升级.</p>

        </div><!-- / body -->
</div><!-- / item -->

		</section><!-- / main -->

<div class="sidebar sright">
        <div class="options">
                <!--
                <ul class="first">
                        <li><a href="#" class="close-all">close all</a></li>
                        <li><a href="#" class="permaview">permaview</a></li>
                        <li><a href="#" class="more-options">options</a></li>
                </ul> --><!-- / first -->
        </div><!-- options -->

        <div class="tabs">
                <ul class="navigation">
                        <!--
                        <li><a href="#" class="current">Timeline</a></li>
                        <li><a href="#">All</a></li>
                        <li><a href="#">Tags</a></li>
                        <li><a href="#">More</a></li>
                        -->
                        <li><span>最近更新</span></li>
                </ul><!-- / navigation -->
                <div class="panes">
                        <div class="pane" id="timeline">
                                <ul>
                                    <li>
                                            <h3>20 Mar 2016</h3>
                                            <ul>
                                                <li><a href="lua-cjson-library.html" tppabs="http://openresty.org/cn/lua-cjson-library.html">Lua Cjson Library</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>17 Mar 2016</h3>
                                            <ul>
                                                <li><a href="download.html" tppabs="http://openresty.org/cn/download.html">Download</a></li>
                                                <li><a href="changelog-1009007.html" tppabs="http://openresty.org/cn/changelog-1009007.html">ChangeLog 1.9.7</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>22 Jan 2016</h3>
                                            <ul>
                                                <li><a href="installation.html" tppabs="http://openresty.org/cn/installation.html">Installation</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>05 Jan 2016</h3>
                                            <ul>
                                                <li><a href="about.html" tppabs="http://openresty.org/cn/about.html">About</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>30 Dec 2015</h3>
                                            <ul>
                                                <li><a href="index.htm" tppabs="http://openresty.org/cn/openresty.html">OpenResty</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>25 Dec 2015</h3>
                                            <ul>
                                                <li><a href="main-menu.html" tppabs="http://openresty.org/cn/main-menu.html">Main Menu</a></li>
                                                <li><a href="changes.html" tppabs="http://openresty.org/cn/changes.html">Changes</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>23 Nov 2015</h3>
                                            <ul>
                                                <li><a href="components.html" tppabs="http://openresty.org/cn/components.html">Components</a></li>
                                                <li><a href="changelog-1009003.html" tppabs="http://openresty.org/cn/changelog-1009003.html">ChangeLog 1.9.3</a></li>
                                                <li><a href="resty-cli.html" tppabs="http://openresty.org/cn/resty-cli.html">Resty CLI</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>11 Aug 2015</h3>
                                            <ul>
                                                <li><a href="donate-online.html" tppabs="http://openresty.org/cn/donate-online.html">Donate Online</a></li>
                                                <li><a href="donors.html" tppabs="http://openresty.org/cn/donors.html">Donors</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>03 Jul 2015</h3>
                                            <ul>
                                                <li><a href="changelog-1007010.html" tppabs="http://openresty.org/cn/changelog-1007010.html">ChangeLog 1.7.10</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>04 Feb 2015</h3>
                                            <ul>
                                                <li><a href="changelog-1007007.html" tppabs="http://openresty.org/cn/changelog-1007007.html">ChangeLog 1.7.7</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>10 Oct 2014</h3>
                                            <ul>
                                                <li><a href="changelog-1007004.html" tppabs="http://openresty.org/cn/changelog-1007004.html">ChangeLog 1.7.4</a></li>
                                            </ul>
                                    </li>
                                    <li>
                                            <h3>13 Jul 2014</h3>
                                            <ul>
                                                <li><a href="changelog-1007002.html" tppabs="http://openresty.org/cn/changelog-1007002.html">ChangeLog 1.7.2</a></li>
                                            </ul>
                                    </li>
                                </ul>
                        </div><!-- / pane -->
                </div><!-- / panes -->
        </div><!-- / tabs -->
</div><!-- / sidebar right -->

	</div><!-- / wrapper -->

<div class="content-footer">
<hr class="footer-sep"/>
<div class="footer">
  <p>版权所有 © 2016 章亦春（agentzh）</p>
  <p>100% 由 OpenResty 和 PostgreSQL 驱动
     （<a href="javascript:if(confirm(%27https://github.com/openresty/openresty.org/  \n\nThis file was not retrieved by Teleport Ultra, because it is addressed on a domain or path outside the boundaries set for its Starting Address.  \n\nDo you want to open it from the server?%27))window.location=%27https://github.com/openresty/openresty.org/%27" tppabs="https://github.com/openresty/openresty.org/">
     查看本站的源代码</a>）</p>
  <br/>
  <p>京ICP备16021991号</p>
</div>
</div>

<script src="jquery.min.js" tppabs="http://openresty.org/js/jquery.min.js"></script>
<script src="main.js" tppabs="http://openresty.org/js/main.js"></script>

<!-- Google analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24724965-1']);
  //_gaq.push(['_setDomainName', 'http://openresty.org/cn/openresty.org']);
  _gaq.push(['_trackPageview']);

  var ga_f = function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www/') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  };
  setTimeout(ga_f, 0);

</script>


</body>
</html>
